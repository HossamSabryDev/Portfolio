<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Clash Detection Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Montserrat:wght@600&display=swap" rel="stylesheet">
<style>
  :root { --bg:#0f1115; --card:#121417; --accent:#1e90ff; --accent2:#00b894; --muted:#aeb6bf; color-scheme: dark; }
  body { margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto; background:var(--bg); color:#eaeaea; }
  header { padding:20px 24px; display:flex; align-items:center; gap:16px; border-bottom:1px solid rgba(255,255,255,0.03); }
  header h1 { margin:0; font-family: Montserrat, sans-serif; color:var(--accent); font-size:20px; }
  .container { max-width:1100px; margin:28px auto; padding:0 18px; }
  .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:18px; }
  .btn { background:var(--accent); border:none; color:#fff; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
  .btn.secondary { background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); }
  .card { background:var(--card); padding:18px; border-radius:10px; margin-bottom:16px; box-shadow:0 6px 18px rgba(0,0,0,0.5); }
  .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:12px; margin-bottom:14px; }
  .stat { font-size:18px; font-weight:700; color:#fff; }
  .muted { color:var(--muted); font-size:13px; }
  table { width:100%; border-collapse:collapse; font-size:13px; }
  th, td { text-align:left; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,0.03); }
  th { font-weight:600; color:var(--muted); font-size:12px; }
  .filter-row { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
  .input, select { background:transparent; border:1px solid rgba(255,255,255,0.06); color:#eaeaea; padding:8px 10px; border-radius:8px; }
  .small { font-size:12px; padding:6px 8px; }
  .tag { background:rgba(255,255,255,0.04); padding:6px 8px; border-radius:6px; font-weight:600; display:inline-block; margin-right:8px;}
  footer { color:var(--muted); text-align:center; margin:30px 0 60px 0; }
  @media (max-width:700px){ header{flex-direction:column;align-items:flex-start} }
</style>
</head>
<body>
<header>
  <h1>Clash Detection Dashboard</h1>
  <div class="muted">Visualize · Categorize · Report</div>
</header>

<div class="container">

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <div class="muted">Load clash export (CSV)</div>
        <input id="fileInput" type="file" accept=".csv,.json" class="input small" />
      </div>
      <div style="display:flex;gap:8px">
        <button id="downloadCsv" class="btn">Download CSV Report</button>
        <button id="printReport" class="btn secondary">Print Report (PDF)</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="filter-row">
      <input id="search" class="input" placeholder="Search by ClashID, Model, Notes..." />
      <select id="statusFilter" class="input small">
        <option value="">All Status</option>
        <option>Open</option><option>Assigned</option><option>Resolved</option>
      </select>
      <select id="priorityFilter" class="input small">
        <option value="">All Priority</option>
        <option>High</option><option>Medium</option><option>Low</option>
      </select>
      <select id="modelFilter" class="input small"><option value="">All Models</option></select>
      <button id="clearFilters" class="btn secondary">Clear</button>
    </div>

    <div class="grid" id="summary">
      <div class="card">
        <div class="muted">Total Clashes</div>
        <div class="stat" id="totalClashes">0</div>
      </div>
      <div class="card">
        <div class="muted">Open</div>
        <div class="stat" id="openClashes">0</div>
      </div>
      <div class="card">
        <div class="muted">Assigned</div>
        <div class="stat" id="assignedClashes">0</div>
      </div>
      <div class="card">
        <div class="muted">Resolved</div>
        <div class="stat" id="resolvedClashes">0</div>
      </div>
    </div>

    <div style="overflow:auto; max-height:520px">
      <table id="clashTable">
        <thead>
          <tr>
            <th>ClashID</th><th>Model A</th><th>Model B</th><th>Category</th><th>Priority</th><th>Location</th><th>Status</th><th>AssignedTo</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="muted">Details</div>
    <div id="detailsArea" style="margin-top:10px">Select a row to see details here.</div>
  </div>

  <footer>© Clash Detection Dashboard · Exported data consumed from Navisworks</footer>
</div>

<script>
  // Minimal CSV parser (handles quoted cells)
  function parseCSV(text) {
    const rows = [];
    const lines = text.split(/\r\n|\n/);
    let i = 0;
    // find header
    while(i < lines.length && lines[i].trim() === '') i++;
    if(i >= lines.length) return rows;
    const header = parseLine(lines[i++]);
    for(; i<lines.length; i++){
      if(lines[i].trim() === '') continue;
      const cols = parseLine(lines[i]);
      if(cols.length === 0) continue;
      const obj = {};
      for(let j=0;j<header.length;j++) obj[header[j]] = cols[j] ?? '';
      rows.push(obj);
    }
    return rows;
  }
  function parseLine(line) {
    const res = [];
    let cur = '', inQuotes = false;
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(inQuotes){
        if(ch === '"' && line[i+1] === '"'){ cur += '"'; i++; }
        else if(ch === '"') inQuotes = false;
        else cur += ch;
      } else {
        if(ch === ','){ res.push(cur); cur = ''; }
        else if(ch === '"'){ inQuotes = true; }
        else cur += ch;
      }
    }
    res.push(cur);
    return res.map(s => s.trim());
  }

  let clashes = [];
  const fileInput = document.getElementById('fileInput');
  const tbody = document.querySelector('#clashTable tbody');
  const search = document.getElementById('search');
  const statusFilter = document.getElementById('statusFilter');
  const priorityFilter = document.getElementById('priorityFilter');
  const modelFilter = document.getElementById('modelFilter');
  const totalClashes = document.getElementById('totalClashes');
  const openClashes = document.getElementById('openClashes');
  const assignedClashes = document.getElementById('assignedClashes');
  const resolvedClashes = document.getElementById('resolvedClashes');
  const detailsArea = document.getElementById('detailsArea');

  fileInput.addEventListener('change', async (e) => {
    const f = e.target.files[0];
    if(!f) return;
    const text = await f.text();
    if(f.name.toLowerCase().endsWith('.json')){
      clashes = JSON.parse(text);
    } else {
      clashes = parseCSV(text);
    }
    initModelFilter();
    renderTable();
    updateSummary();
  });

  function initModelFilter(){
    const models = new Set();
    clashes.forEach(c => { if(c.ModelA) models.add(c.ModelA); if(c.ModelB) models.add(c.ModelB); });
    modelFilter.innerHTML = '<option value="">All Models</option>';
    Array.from(models).sort().forEach(m => {
      const opt = document.createElement('option'); opt.value = m; opt.textContent = m; modelFilter.appendChild(opt);
    });
  }

  function renderTable(){
    const q = search.value.trim().toLowerCase();
    tbody.innerHTML = '';
    const filtered = clashes.filter(c => {
      if(statusFilter.value && (c.Status ?? '').toLowerCase() !== statusFilter.value.toLowerCase()) return false;
      if(priorityFilter.value && (c.Priority ?? '').toLowerCase() !== priorityFilter.value.toLowerCase()) return false;
      if(modelFilter.value && !( (c.ModelA||'').toLowerCase() === modelFilter.value.toLowerCase() || (c.ModelB||'').toLowerCase() === modelFilter.value.toLowerCase() )) return false;
      if(q && !( (c.ClashID||'').toLowerCase().includes(q) || (c.ModelA||'').toLowerCase().includes(q) || (c.ModelB||'').toLowerCase().includes(q) || (c.Notes||'').toLowerCase().includes(q) )) return false;
      return true;
    });

    filtered.forEach(c => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${c.ClashID||''}</td><td>${c.ModelA||''}</td><td>${c.ModelB||''}</td><td>${c.Category||''}</td><td>${c.Priority||''}</td><td>${c.Location||''}</td><td>${c.Status||'Open'}</td><td>${c.AssignedTo||''}</td>`;
      tr.style.cursor = 'pointer';
      tr.addEventListener('click', () => showDetails(c));
      tbody.appendChild(tr);
    });
  }

  function showDetails(c){
    detailsArea.innerHTML = `
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="flex:1">
          <div class="tag">ID: ${c.ClashID||''}</div>
          <div style="margin-top:8px"><strong>Models:</strong> ${c.ModelA||''} ⇄ ${c.ModelB||''}</div>
          <div style="margin-top:6px"><strong>Category:</strong> ${c.Category||''}</div>
          <div style="margin-top:6px"><strong>Priority:</strong> ${c.Priority||''}</div>
          <div style="margin-top:6px"><strong>Location:</strong> ${c.Location||''}</div>
          <div style="margin-top:6px"><strong>Coordinates:</strong> ${c.X||''}, ${c.Y||''}, ${c.Z||''}</div>
          <div style="margin-top:6px"><strong>Status:</strong> ${c.Status||'Open'}</div>
          <div style="margin-top:6px"><strong>Assigned To:</strong> ${c.AssignedTo||''}</div>
          <div style="margin-top:8px"><strong>Notes:</strong><div style="margin-top:6px">${(c.Notes||'').replace(/\n/g,'<br/>')}</div></div>
        </div>
        <div style="min-width:220px">
          <div class="muted">Quick update</div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-direction:column">
            <input id="assignName" class="input small" placeholder="Assign to (name)" />
            <select id="statusSelect" class="input small">
              <option>Open</option><option>Assigned</option><option>Resolved</option>
            </select>
            <button class="btn" id="saveUpdate">Save</button>
          </div>
        </div>
      </div>
    `;
    // wire save button
    document.getElementById('saveUpdate').onclick = () => {
      const name = document.getElementById('assignName').value.trim();
      const newStatus = document.getElementById('statusSelect').value;
      c.AssignedTo = name;
      c.Status = newStatus;
      renderTable();
      updateSummary();
      showDetails(c);
    };
  }

  function updateSummary(){
    totalClashes.textContent = clashes.length;
    openClashes.textContent = clashes.filter(c => (c.Status||'Open').toLowerCase() === 'open').length;
    assignedClashes.textContent = clashes.filter(c => (c.Status||'').toLowerCase() === 'assigned').length;
    resolvedClashes.textContent = clashes.filter(c => (c.Status||'').toLowerCase() === 'resolved').length;
  }

  search.addEventListener('input', renderTable);
  statusFilter.addEventListener('change', renderTable);
  priorityFilter.addEventListener('change', renderTable);
  modelFilter.addEventListener('change', renderTable);
  document.getElementById('clearFilters').addEventListener('click', () => {
    search.value=''; statusFilter.value=''; priorityFilter.value=''; modelFilter.value=''; renderTable();
  });

  // Download CSV: takes current filtered view and generates CSV
  document.getElementById('downloadCsv').addEventListener('click', () => {
    const rows = [];
    // header
    rows.push(['ClashID','ModelA','ModelB','Category','Priority','Location','X','Y','Z','Status','AssignedTo','Notes','CreatedAt']);
    // gather current filtered items from displayed rows
    const displayed = Array.from(tbody.querySelectorAll('tr')).map(tr => tr.querySelectorAll('td')[0].textContent);
    const toExport = clashes.filter(c => displayed.includes(c.ClashID));
    toExport.forEach(c => rows.push([c.ClashID,c.ModelA,c.ModelB,c.Category,c.Priority,c.Location,c.X,c.Y,c.Z,c.Status,c.AssignedTo, (c.Notes||''), c.CreatedAt || '']));
    const csv = rows.map(r => r.map(cell => `"${(''+cell).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'clash-report.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // Print/Save as PDF
  document.getElementById('printReport').addEventListener('click', () => {
    // simple printable view: open new window with summary + table
    const printWindow = window.open('', '_blank');
    const style = `<style>
      body{font-family:Inter,Arial;color:#111;background:#fff;padding:20px}
      h1{color:#111}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #ddd;padding:8px;text-align:left;font-size:12px}
    </style>`;
    let html = `<html><head><title>Clash Report</title>${style}</head><body><h1>Clash Report</h1>`;
    html += `<p>Total clashes: ${clashes.length}</p>`;
    html += '<table><thead><tr><th>ClashID</th><th>Models</th><th>Priority</th><th>Location</th><th>Status</th><th>Assigned</th></tr></thead><tbody>';
    clashes.forEach(c => {
      html += `<tr><td>${c.ClashID||''}</td><td>${(c.ModelA||'')+' ⇄ '+(c.ModelB||'')}</td><td>${c.Priority||''}</td><td>${c.Location||''}</td><td>${c.Status||''}</td><td>${c.AssignedTo||''}</td></tr>`;
    });
    html += '</tbody></table></body></html>';
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.focus();
    // Wait briefly then trigger print
    setTimeout(()=>printWindow.print(), 500);
  });

  // Example: load sample data if you want quick demo
  const sampleCsv = `ClashID,ModelA,ModelB,Category,Priority,Location,X,Y,Z,Status,AssignedTo,Notes,CreatedAt
C-0001,Structure.rvt,MEP.rvt,Structure-MEP,High,Level 02,12.3,45.6,3.5,Open,,Beam interference with pipe,2025-09-01T08:00:00Z
C-0002,Architectural.rvt,MEP.rvt,Arch-MEP,Medium,Level 01,5.1,22.0,0.8,Assigned,Ahmed,Door swing conflict,2025-09-02T12:30:00Z
`;
  // Uncomment to preload sample:
  // clashes = parseCSV(sampleCsv); initModelFilter(); renderTable(); updateSummary();

</script>
</body>
</html>
